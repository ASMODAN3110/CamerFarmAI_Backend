services:
  backend:
    image: camerfarmai-backend:latest
    container_name: camerfarmai-backend
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile
    networks:
      - internal        # For PostgreSQL connection
      - traefik-net     # For Traefik reverse proxy
    env_file:
      - .env            # Load all environment variables from .env file
    volumes:
      - ./uploads:/app/uploads  # Persist uploaded files (avatars, etc.)
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # HTTPS Router (main entrypoint)
      - "traefik.http.routers.backend.rule=Host(`backend.camerfarm.strife-cyber.org`)"
      - "traefik.http.routers.backend.entrypoints=https"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.backend.service=backend"

      # Service configuration
      - "traefik.http.services.backend.loadbalancer.server.port=3000"
      - "traefik.docker.network=traefik-net"

      # Middleware (optional - for authentication, rate limiting, etc.)
      # - "traefik.http.routers.backend.middlewares=backend-auth"
    # Note: depends_on removed since PostgreSQL is external
    # If PostgreSQL is in this compose file, uncomment:
    # depends_on:
    #   - postgres
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/v1/auth/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # PostgreSQL service (if not using external container)
  # Uncomment and configure if you want to run PostgreSQL via docker-compose
  # postgres:
  #   image: postgres:16-alpine
  #   container_name: postgres
  #   restart: unless-stopped
  #   networks:
  #     - internal
  #   environment:
  #     POSTGRES_USER: cameruser
  #     POSTGRES_PASSWORD: admin
  #     POSTGRES_DB: camerfarm
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U cameruser -d camerfarm"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

networks:
  internal:
    external: true  # Use existing network (created separately or by PostgreSQL container)
  traefik-net:
    external: true  # Use existing Traefik network

# Uncomment if using PostgreSQL via docker-compose
# volumes:
#   postgres_data:
